import{A as R,b as rr,C as V}from"./B4NmBDdK.js";import{Y as Q,_ as j,k as er,ak as $,aj as U,Z as Y,w as G,al as k,ac as A,u as Z,R as tr,J as ir,T as nr,U as ar,S as sr,V as or}from"./eDSVRnne.js";import{F as lr}from"./Ck0Mm-KV.js";import{f as K}from"./Bwhk0B3v.js";import{C as m,s as X,$ as ur}from"./CTSfBx87.js";const vr={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},_r=(r,e,t)=>{let s=[];return{updatedProducts:r.map(i=>{if(i._id===t._id){if(e>i.max)return i.qty=i.qty,s.push(`A maximum of ${i.max} units of ${i.name} only can be purchased`),i;if(e>i.price.availableQuantity&&i.price.trackInventory&&!i.price.allowOutOfStockPurchases)return i.qty=i.qty,s.push(`Only ${i.price.availableQuantity} units of ${i.name} are in stock`),i;i.qty=e}return i}),errorMessages:s}},br=r=>{var e,t,s;return((e=r==null?void 0:r.price)==null?void 0:e.availableQuantity)<=0&&((t=r==null?void 0:r.price)==null?void 0:t.trackInventory)&&!((s=r==null?void 0:r.price)!=null&&s.allowOutOfStockPurchases)},Er=(r,e)=>e.find(t=>t._id===r.id),dr=async({contactId:r,domain:e,pageUrl:t,locationId:s,productPreviewList:l,isCouponApplied:i,couponCode:n,couponSessionId:a,store:c,subType:f,traceId:S="",reCaptchaToken:o,isEcommercePurchase:I,shippingRateId:d,toZip:w,toState:O,toCountry:P,shippingCarrierRateId:F,note:N,separateBillingAddress:C})=>{var v,_,b,g;try{const h=m("msgsndr_id").value,W=m("am_id").value,x=m("am_fingerprint").value,M=c.funnelName||"funnel";e||(e=window.location.hostname,t=window.location.pathname);const{funnelPageId:J,funnelId:q,stepId:L}=c,T={altId:s,altType:"location",shippingRateId:d,shippingCarrierRateId:F,contactId:r,source:{type:c.pageType===k.FUNNEL?k.FUNNEL:k.WEBSITE,subType:f,id:q,name:M,meta:{stepId:L,pageId:J,domain:e,pageUrl:t,affiliateManager:{id:W,fingerprint:x}}},products:l.map(E=>({id:I?E.selectedPrice._id:E._id,qty:E.qty||E.quantity})),fingerprint:h,trackingId:$(),traceId:S,toZip:w,toState:O,toCountry:P,customerNote:N,separateBillingAddress:C};i&&(T.couponCode=n,T.couponSessionId=a),o&&(T.captchaToken=o);const y=await A.createOrder(T);if(!((v=y.order)==null?void 0:v._id))throw new Error("Something went wrong while creating order. Please try again later.");return y}catch(h){return console.error(h),{error:!0,message:(b=(_=h==null?void 0:h.response)==null?void 0:_._data)==null?void 0:b.message,status:(g=h==null?void 0:h.response)==null?void 0:g.status}}},gr=async(r,e,t,s,l,i,n)=>{var z,E,B;const a=m("msgsndr_id").value,c=m("am_id").value,f=m("am_fingerprint").value,S=tr(r.locationId),o=ir(r.locationId),I=nr(),d=r.funnelName||"funnel";let{domain:w,page_url:O}=e.query;w||(w=window.location.hostname,O=window.location.pathname);const{funnelPageId:P,funnelId:F,stepId:N}=r,C={eventType:"optin",domainName:w,pageUrl:O,funnelId:F,pageId:P,stepId:N},{address:v,country:_,state:b,city:g,zipcode:h,fullName:W,phoneNumber:x,emailId:M,companyName:J}=t,q={addressLine1:v,country:_||s,state:b,city:g,zip:h};I.medium=ar.OrderForm,I.mediumId=C.stepId;const L=sr();I.fbEventId=L;const T={lead:!0,eventData:I,source:d,pageId:P,funnelId:F,sessionId:S,funnelEventData:C,sessionFingerprint:o||null},y={locationId:r.locationId,name:W,phone:x,email:(M==null?void 0:M.toLowerCase())||"",companyName:J,address:q,attribution:T,timezone:or(),amId:String(c),amFingerprint:f,orderFormType:"one_step_form_submission",captchaToken:l,billingAddress:n};i.enableStickyContact&&(y.attribution.fingerprint=a,y.attribution.funnelEventData.fingerprint=a),i.enableForceCreate&&(y.attribution.forceCreate=!0),i.enableEmailValidation&&(y.attribution.session_d=Number(i.enableEmailValidation)||0);try{const u=await lr.createContact(y);if(!u)throw new Error("Something went wrong. Please try again later.");if(u.fbEventId=L,a!==u.fingerprint){r.fingerprint=a;const D=m("msgsndr_id",{path:"/",maxAge:31536e3});D.value=u.fingerprint}$();const p=Y(u);G("_ud",p),X(()=>{K("track","SubmitApplication")});let H=u.sessionFingerprint;return I&&(Q({sessionId:u.sessionId||null,locationId:r.locationId}),H&&j(r.locationId,H)),u}catch(u){return console.error(u),{error:!0,message:(E=(z=u==null?void 0:u.response)==null?void 0:z._data)==null?void 0:E.message,status:(B=u==null?void 0:u.response)==null?void 0:B.status}}},Or=async(r,e,t,s,l,i,n,a,c,f,S,o,I,d,w,O,P,F,N,C)=>{var v,_,b;if((!n||!n.id)&&(n=await gr(r,e,t,s,l,i,F),l=void 0),n!=null&&n.error){let g={};return(n==null?void 0:n.status)===429?(g={error:!0,processingPayment:!1,showRecaptcha:!0},g):(g={error:!0,processingPayment:!1,cardErrorMsg:n.message||"We're sorry, but something went wrong. Please try again"},g)}if((n.id&&!a||!((v=a==null?void 0:a.order)!=null&&v._id))&&(a=await dr({contactId:n==null?void 0:n.id,domain:r.domain,pageUrl:r.pageUrl,locationId:r.locationId,productPreviewList:f,isCouponApplied:c,couponCode:o,couponSessionId:S,store:r,subType:d,traceId:n==null?void 0:n.traceId,reCaptchaToken:l,isEcommercePurchase:I,shippingRateId:w,toZip:(t==null?void 0:t.zipcode)??((_=t.address)==null?void 0:_.zip),toState:O,toCountry:(t==null?void 0:t.country)??((b=t.address)==null?void 0:b.country),shippingCarrierRateId:P,note:N,separateBillingAddress:C}),l=void 0),a!=null&&a.error){let g={};return a.status===429?(g={error:!0,processingPayment:!1,showRecaptcha:!0,contactResponse:n},g):(g={error:!0,processingPayment:!1,contactResponse:n,cardErrorMsg:a.message||"We're sorry, but something went wrong. Please try again"},g)}return(a==null?void 0:a.success)===!1?{error:!0,cardErrorMsg:a==null?void 0:a.message,processingPayment:!1}:(sessionStorage.setItem("orderResponse",JSON.stringify(a)),d!=U.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),sessionStorage.setItem("orderResponse",JSON.stringify(a)),d!=U.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),sessionStorage.setItem("orderResponse",JSON.stringify(a)),d!=U.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),{contactResponse:n,orderResponse:a,reCaptchaToken:l})},mr=(r,e,t,s)=>{if($()!=(t==null?void 0:t.verifiedTrackingId)){const i=m("tr",{path:"/",maxAge:900});i.value=t==null?void 0:t.verifiedTrackingId}if(s!==U.TWO_STEP_ORDER_FORM){if(r.fingerprint!==e){const n=m("msgsndr_id",{path:"/",maxAge:31536e3});n.value=r.fingerprint}const i=Y(r);G("_ud",i)}if(r.fbEventId){let i=r.fbEventId;X(()=>{K("track","OrderFormPurchase",i)})}else console.warn("Facebook event Id missing from attribution!")},Pr=async(r,e,t,s,l)=>{let i=!1,n="";if(e!=null&&e.message&&!(e!=null&&e.success))throw new Error(e.message);t===R&&(e!=null&&e.pendingConfirmation)&&(i=!0,n="Order placed successfully! However your transaction is pending for review. Please contact the business owner");const a=m("msgsndr_id").value;await mr(r,a,e,l);const c=m("provider");c.value=t===rr?"pp":t===V?V:"cc",await cr({sessionId:r.sessionId,sessionFingerprint:e==null?void 0:e.sessionFingerprint},s);const f=sessionStorage.getItem("redirect");if(fr(s),f){sessionStorage.removeItem("redirect"),window.location.href=f;return}return{paymentResponseData:e,authorizeOrderPendingConfirmation:i,authorizeOrderAlertMsg:n}},cr=(r,e)=>{r&&r.sessionId&&(Q({sessionId:r.sessionId||null,locationId:e}),r.sessionFingerprint&&j(e,r.sessionFingerprint))},Fr=r=>{var t;(!(r.keyCode>=48&&r.keyCode<=57||r.keyCode>=96&&r.keyCode<=105)||!/^\d{0,2}$/.test((t=r.target)==null?void 0:t.value))&&r.keyCode!==8&&r.preventDefault()},fr=r=>{const e=er();return sessionStorage.setItem(`couponSessionId_${r}`,e),e},Cr=async(r,e,t="",s,l,i)=>{var n,a,c,f,S;try{const o=Z(),I={altId:o.value.locationId,altType:"location",couponCode:t,source:{type:o.value.pageType===k.FUNNEL?k.FUNNEL:k.WEBSITE,subType:e,id:o.value.funnelId,name:o.value.funnelName,meta:{stepId:o.value.stepId,pageId:o.value.funnelPageId,domain:o.value.domain,pageUrl:o.value.pageUrl,affiliateManager:{id:m("am_id").value,fingerprint:m("msgsndr_id").value}}},products:r,toCountry:s,toState:l,toZip:i},d=await A.getAmountSummary(I);return{total:d.summary.total,subtotal:d.summary.subtotal,taxSummary:d.summary.taxSummary,subtotalWithDiscount:d.summary.subtotalWithDiscount,futureRecurringPaymentAmount:(n=d.recurringSummary)==null?void 0:n.subtotalWithDiscount}}catch(o){return console.error(o),{error:!0,message:((c=(a=o==null?void 0:o.response)==null?void 0:a._data)==null?void 0:c.message)||"Something went wrong while fetching order total. Please try again later",status:(S=(f=o==null?void 0:o.response)==null?void 0:f._data)==null?void 0:S.status}}},Tr=async(r,e)=>{const t=await A.getLastPaymentMethodForTheCustomer({altId:r,altType:"location",contactId:e});return{paymentProvider:t==null?void 0:t.paymentProvider,paymentMethod:t==null?void 0:t.paymentMethod}},kr=async(r,e)=>await A.getLastSquarePaymentMethodForTheCustomer({altId:r,altType:"location",contactId:e}),Nr=(r,e,t,s)=>{const l=e<=0&&!t,i=t&&s<=0,n=l||i;return!!(r&&n||n)},Mr=async()=>{const r=Z();try{const e=await A.getStatesInformation();if(e&&e.error)throw ur(e.error);r.value.countryList=(e==null?void 0:e.data)??[]}catch(e){console.error("Failed to fetch country list",e)}},Ar=r=>Z().value.countryList.find(t=>t.code===r),Lr=(r,e,t)=>{if(r.startsWith("+44")&&e.match(/^07\d*$/)){const s=r.replace("+44 1534","+44").replace("1534","");return window.libphonenumber.parsePhoneNumberFromString(s,"JE").formatInternational()}return t.formatInternational()};export{Cr as a,Mr as b,dr as c,kr as d,Lr as e,Tr as f,Ar as g,Pr as h,fr as i,br as j,Er as k,_r as l,Or as m,Fr as n,Nr as p,vr as s};
